<!DOCTYPE html>
<html>
<head>
    <title>Wavelet Coherence Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        body { background: #181818; color: #cccccc; font-family: 'Segoe UI', Arial, sans-serif; }
        .container { max-width: 900px; margin: 40px auto; }
        .card { background: #232323; color: #cccccc; border: 1px solid #444; }
        .plot-container { margin-bottom: 2rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card shadow p-4">
            <h2 class="mb-4 text-center">Wavelet Coherence Analysis</h2>

            <div class="plot-container">
                <h4 class="text-center mb-3">Last 30 Minutes</h4>
                <div id="live-chart-30m" style="height: 400px;"></div>
            </div>

            <div class="plot-container">
                <h4 class="text-center mb-3">Detrended Data</h4>
                <div id="detrended-chart" style="height: 400px;"></div>
            </div>

            <div class="plot-container">
                <h4 class="text-center mb-3">Wavelet Coherence</h4>
                <div id="coherence-plot" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        
        async function fetchData() {
            const response = await fetch('/api/live-data?range=30m');
            return await response.json();
        }

        function plotMainChart(data) {
            const trace_btc = {
                x: data.time,
                y: data.btc,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f28e2b', width: 3 },
                name: 'BTC/USDT'
            };
            const trace_eth = {
                x: data.time,
                y: data.eth,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#4e79a7', width: 3 },
                name: 'ETH/USDT'
            };
            let yAll = data.btc.concat(data.eth);
            let yMin = Math.min(...yAll);
            let yMax = Math.max(...yAll);
            let eps = 1e-6;
            let yRange = [yMin - eps, yMax + eps];
            let xRange = [data.time[0], data.time[data.time.length - 1]];
            const layout = {
                plot_bgcolor: "#232323",
                paper_bgcolor: "#232323",
                font: { color: "#cccccc", family: "Segoe UI, Arial, sans-serif" },
                xaxis: { title: "time", showgrid: true, gridcolor: "#444", tickmode: "auto", nticks: 8, range: xRange },
                yaxis: { title: "Relative Change (%)", showgrid: true, gridcolor: "#444", range: yRange, autorange: false },
                legend: { orientation: "h", x: 0.5, xanchor: "center", y: 1.1 },
                margin: { t: 40, l: 60, r: 30, b: 60 },
                transition: { duration: 400, easing: "cubic-in-out" }
            };
            // Only plot if there is data
            if (data.time.length > 0 && data.btc.length > 0 && data.eth.length > 0) {
                Plotly.react('live-chart-30m', [trace_btc, trace_eth], layout, {responsive: true, displayModeBar: false});
            } else {
                // Clear the chart if no data
                Plotly.purge('live-chart-30m');
            }
        }

        function plotDetrendedChart(data) {
            const traces = [{
                x: data.time,
                y: data.btc_detrended,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#f28e2b', width: 3 },
                name: 'BTC/USDT'
            }, {
                x: data.time,
                y: data.eth_detrended,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#4e79a7', width: 3 },
                name: 'ETH/USDT'
            }];

            const layout = {
                plot_bgcolor: "#232323",
                paper_bgcolor: "#232323",
                font: { color: "#cccccc" },
                xaxis: { showgrid: false, visible: false }, // Hide x axis and ticks
                yaxis: { showgrid: false, visible: false }, // Hide y axis and ticks
                legend: { orientation: "h", y: 1.1 },
                margin: { t: 40, l: 60, r: 30, b: 60 }
            };

            Plotly.react('detrended-chart', traces, layout, {responsive: true, displayModeBar: false});
        }

        function plotCoherence(data) {
            const nPeriods = data.periods.length;
            const nTime = data.coherence[0]?.length || 0;
            let xLabels = data.time;
            if (xLabels.length !== nTime) {
                xLabels = Array.from({length: nTime}, (_, i) => i);
            }

            const yticks = [40, 50, 75, 100, 150, 200, 300, 400, 500];
            const yticksInRange = yticks.filter(tick => tick >= Math.min(...data.periods) && tick <= Math.max(...data.periods));

            // Remove all arrows: do not create or add any annotations

            const trace = {
                z: data.coherence,
                x: xLabels,
                y: data.periods,
                type: 'heatmap',
                colorscale: 'Jet',
                zmin: 0,
                zmax: 1
            };

            const layout = {
                plot_bgcolor: "#232323",
                paper_bgcolor: "#232323",
                font: { color: "#cccccc" },
                xaxis: { showgrid: false, title: "Time", range: [xLabels[0], xLabels[nTime - 1]] },
                yaxis: { 
                    type: 'log',
                    title: "Period (seconds)",
                    autorange: true,
                    tickvals: yticksInRange,
                    ticktext: yticksInRange.map(String)
                },
                margin: { t: 40, l: 80, r: 30, b: 60 }
                // No annotations
            };

            Plotly.react('coherence-plot', [trace], layout, {responsive: true, displayModeBar: false});
        }

        async function updateCharts() {
            try {
                const data = await fetchData();
                if (!data || !data.btc || !data.eth || !data.time) {
                    console.error('Invalid data format received');
                    return;
                }
                
                currentData = data;
                plotMainChart(data);
                
                // Get detrended data
                try {
                    const detrended = await fetch('/api/detrend', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            btc: data.btc.map(Number),  // Ensure numbers
                            eth: data.eth.map(Number)   // Ensure numbers
                        })
                    }).then(async r => {
                        if (!r.ok) throw new Error(await r.text());
                        return r.json();
                    });
                    
                    if (detrended && detrended.btc_detrended && detrended.eth_detrended) {
                        plotDetrendedChart({...detrended, time: data.time});
                        
                        // Calculate coherence only if we have detrended data
                        try {
                            const coherence = await fetch('/api/coherence', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    btc: detrended.btc_detrended,
                                    eth: detrended.eth_detrended
                                })
                            }).then(async r => {
                                if (!r.ok) throw new Error(await r.text());
                                return r.json();
                            });
                            
                            if (coherence && coherence.coherence) {
                                plotCoherence(coherence);
                            }
                        } catch (e) {
                            console.error('Coherence calculation failed:', e);
                        }
                    }
                } catch (e) {
                    console.error('Detrending failed:', e);
                }
            } catch (e) {
                console.error('Update failed:', e);
            }
        }

        // Start updates
        document.addEventListener("DOMContentLoaded", function() {
            updateCharts();
            setInterval(updateCharts, 1000);  // Update every 1 second
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
